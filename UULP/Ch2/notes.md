# 本章目的
- 学习Unix的文件操作
- 从Unix联机帮助中得到信息

# who

## 命令就是程序
- 几乎所有命令都是人为编写的程序
- 你可以将可执行文件放入`/usr/bin`,`/bin`等目录。
- 那些东西随着用的人多，便成为了Unix标准命令。

## 工作原理
- 通过读文件获得信息，每个登陆用户在文件中有对应记录
- 即打开utmp,将存放的结构数组中的用户信息一个一个读出，显示记录，关闭文件。

## 编写
### v1
1. 从文件中读取数据结构
	- open,read,close
2. 问题
	- 空白记录
	- 时间显示不正确

### v2
1. 过滤那些非登陆用户值
	- utmp结构中有一个成员`ut_type`,它的值为7,证明是一个已登陆的用户

2. time_t
	- `typedef long int time_t`
	- `ctime`将时间整数值转换成日常使用格式,再截取需要的部分

# cp
## cp做的事
- `cp sourcefile targetfile`
- 若tf不存在，就创建，若存在，就覆盖。
## 编写cp过程
``` 
-----------------------------------------------------
	open sourcefile for reading
	open copyfile for writing 
     +->read from source to buffer --eof ?	-+
		 |_ write from buffer to copy	 | 
						 |
	close sourcefile  <----------------------+
	close copyfile
-----------------------------------------------------
 ```
# 提高I/O效率
## 缓冲区大小很重要
- e.g. 用勺子转移汤，大的勺子效率更高，文件操作**亦是如此**。

## 系统调用问题
- 系统调用是非常耗时的
- 因为工作在管理员模式，可以直接访问很多设备，全部内存空间等资源，但是用户模式就很受限。这两种模式切换的话，是需要保存模式的上下文环境的。
- 所以，应该尽可能少的模式切换
- e.g. 超人如果一直在普通人和超人状态切换，就没时间拯救世界了。

## 分析who_v2.c的效率
- 每次从utmp读取一条记录，十分低效.
- e.g.需要煎3荷包蛋，每次去超市买一个，去三次。
- 所以，需要一次吧utmp中的记录读入多个放入缓存区。

## 改进who_v2.c
- 通过`utmplib`来缓冲
1. main调用`utmplib.c`中函数取一条记录
2. utmplib中的函数每次从文件读取6条记录放入数组
3. 当数组6条记录全被取走，才调用内核服务重新读取数据

## 内核缓冲技术
- 内核也可以使用缓冲技术提高磁盘的访问速度
1. 内核将磁盘的数据块复制到内核缓冲区，
2. 当用户空间要从磁盘读取数据时，内核一般不读磁盘，而是把内核缓冲区的数据复制到进程的缓冲区。
3. 当所要求数据不再，内核会把它加入到请求列表，把该进程挂起，弄完后，再唤醒进程。
# 函数
||write|
|:---|:---|
|目标|将内存中数据写入文件|
|头文件|`#include <unistd.h>`|
|参数|fd 文件描述符<br>buf 内存数据<br>amt 要写的字节数|
|返回值|-1 遇到错误<br> num written 成功写入|
|人话:joy:|1.告诉内核将内存指定数据写入文件，若不能写入或失败，返回`-1`;若成功，返回`写入字节数`。<br> 2.调用write后，检查返回值和要写的字节数是否一致，若不同，要采取一些措施|

